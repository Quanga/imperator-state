

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>JSDoc: models/blastModel.js</title>

    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./build/entry.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Muli:100,400,700|Oswald:300|Inconsolata,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
    <link type="text/css" rel="stylesheet" href="styles/app.min.css">
    <link type="text/css" rel="stylesheet" href="styles/iframe.css">
</head>

<body>
    <div id="stickyNavbarOverlay"></div>
    <div class="top-navbar">
        <div class="container">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                    
                     
                        <h1 class="navbar-item">State Management Server</h1>
                    
                    <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                 
                <div class="navbar-menu">
                    <div class="navbar-end">
                    
                        <div class="navbar-item">
                            <a href="https://github.com/SoftwareBrothers/admin-bro" target="_blank">Github</a>
                        </div>
                    
                        <div class="navbar-item">
                            <a href="https://admin-bro-example-app.herokuapp.com/admin" target="_blank">Example Application</a>
                        </div>
                    
                    </div>
                </div>
                
            </nav>
        </div>
    </div>
    <div class="container">
        <div class="columns">
            <div class="column is-3" id="sidebarNav">
                <div class="sidebar">
                    <nav>
                        <h2><a href="index.html">Home</a></h2><div class="category"><h3><a href="global.html">Global</a></h3></div><div class="category"><h2>Models</h2><h3>Classes</h3><ul><li><a href="BlastModel.html">BlastModel</a></li><li><a href="ControlUnitModel.html">ControlUnitModel</a></li><li><a href="DataModel.html">DataModel</a></li><li><a href="UnitModel.html">UnitModel</a></li></ul></div><div class="category"><h2>Repositories</h2><h3>Classes</h3><ul><li><a href="BlastRepository.html">BlastRepository</a></li></ul></div><div class="category"><h2>Services</h2><h3>Classes</h3><ul><li><a href="BlastService.html">BlastService</a></li><li><a href="DataService.html">DataService</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="uiService.html">uiService</a></li></ul><h3>Events</h3><ul><li><a href="BlastModel.html#event:state">state</a></li><li><a href="DataService.html#event:EDDSIG">EDDSIG</a></li><li><a href="global.html#event:DataService">DataService</a></li></ul></div><div class="category"><h2>Utilities</h2><h3>Modules</h3><ul><li><a href="module-lib_mappers_data_mapper.html">lib/mappers/data_mapper</a></li></ul><h3>Classes</h3><ul><li><a href="module-lib_mappers_data_mapper-DataMapper.html">DataMapper</a></li></ul></div>
                    </nav>
                </div>
            </div>
            <div class="column is-9-desktop">
                <div class="content" id="main-content-wrapper">
                    <header class="page-title">
                        <p>Source</p>
                        <h1>models/blastModel.js</h1>
                    </header>
                    
                    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const uuid = require("uuid");
const EventEmitter = require("events").EventEmitter;
const isTimestamp = require("validate.io-timestamp");

const { blastModelStates, blastUnitStates } = require("../constants/stateConstants");
const { blastModelEvents } = require("../constants/eventConstants");
const { eventServiceLogTypes } = require("../constants/typeConstants");

/**
 * @category Models
 * @class
 * @summary Creates an instance of BlastModel.
 * @param {object} snapshot - snapshot of the DataModel supplied by the Data Service
 * @param {number} createdAt - the timestamp from the fire button packet
 * @param {number} duration - the firing time of the process
 */
class BlastModel {
	constructor(snapshot, createdAt, firingDuration, reportingDuration) {
		this.validate(snapshot, createdAt, firingDuration, reportingDuration);

		this.event = new EventEmitter();
		const snapShotProcessed = this.createSnapshot(snapshot);

		this.data = {
			id: uuid.v4(),
			serial: snapshot.controlUnit.data.serial,
			createdAt: createdAt,
			firingComplete: null,
			firingTime: null,
			blastClosed: null,
			blastReturnTime: null,
			snapshots: { start: snapShotProcessed.snapShotObj, end: null },
			logs: [],
			state: null
		};

		const totalDuration = firingDuration + reportingDuration;
		this.timer = this.setTotalTimer(createdAt, totalDuration);
		this.watchLists = snapShotProcessed.watchLists;
		this.expectedComplete = createdAt + totalDuration;

		this.setState(blastModelStates.BLAST_FIRING);
	}

	/**
	 * @summary validate the args coming into the Blast Model
	 * @param {string || number} serial Data Model SnapShot Object
	 * @param {object} snapShot Data Model SnapShot Object
	 * @param {number} createdAt Data Model SnapShot Object
	 * @param {number} duration Data Model SnapShot Object
	 * @returns {bool} Blast Model Snapshot Object
	 */
	validate(snapshot, createdAt, firingDuration, reportingDuration) {
		for (let index = 0; index &lt; arguments.length; index++) {
			if (!arguments[index])
				throw new Error("All arguments must be specified to create a Blast Model");
		}

		if (typeof snapshot !== "object" || snapshot.constructor !== Object)
			throw new Error("Snapshot must be suppled as an Object");

		if (!isTimestamp(createdAt))
			throw new Error("Created date is not valid...cannot create Blast Model");

		if (typeof firingDuration !== "number")
			throw new Error("Firing Duration is not a valid Number - check env");

		if (typeof reportingDuration !== "number")
			throw new Error("Report Duration is not a valid Number - check env");

		if (!process.env.NODE_ENV === "test" &amp;&amp; reportingDuration &lt; 10000)
			throw new Error(`Report Duration is too low - ${reportingDuration}ms`);

		if (!process.env.NODE_ENV === "test" &amp;&amp; firingDuration &lt; 10000)
			throw new Error(`Firing Duration is too low - ${firingDuration}ms`);

		return true;
	}

	/**
	 * Function to take in a snapshot from the Data Model and work out the format
	 * @param {*} snapShot Data Model SnapShot Object
	 * @returns {object} Blast Model Snapshot Object
	 */
	createSnapshot(snapShot) {
		const { controlUnit, units } = snapShot;
		try {
			const aggregatedUnits = this.aggregateUnits(units);

			const snapShotObj = {
				controlUnit,
				...aggregatedUnits
			};

			const watchLists = this.extractWatchLists(aggregatedUnits.blastUnits);

			return { snapShotObj, watchLists };
		} catch (err) {
			console.log(err);
		}
	}

	aggregateUnits(units) {
		const unitSnapshot = { blastUnits: {}, excludedUnits: {}, disarmedUnits: {} };

		const unitKeys = Object.keys(units);
		if (unitKeys.length === 0) return null;

		unitKeys.forEach(unitKey => {
			const { keySwitchStatus } = units[unitKey].data;
			const { unitsCount } = units[unitKey].units;

			let state = blastUnitStates.DISARMED;

			if (keySwitchStatus === 1 &amp;&amp; unitsCount > 0) state = blastUnitStates.ARMED;
			if (keySwitchStatus === 0 &amp;&amp; unitsCount > 0) state = blastUnitStates.EXCLUDED;

			switch (state) {
			case blastUnitStates.ARMED:
				unitSnapshot.blastUnits[unitKey] = units[unitKey];
				break;
			case blastUnitStates.DISARMED:
				unitSnapshot.disarmedUnits[unitKey] = units[unitKey];
				break;
			case blastUnitStates.EXCLUDED:
				unitSnapshot.excludedUnits[unitKey] = units[unitKey];
				break;
			}
		});

		return unitSnapshot;
	}

	extractWatchLists(units) {
		const blastParticipants = { units: {}, count: 0 };

		const unitKeys = Object.keys(units);

		unitKeys.forEach(unitKey => {
			if (units[unitKey].hasOwnProperty("children")) {
				const detKeys = Object.keys(units[unitKey].children);

				if (detKeys.length > 0) {
					let liveChildren = detKeys.filter(
						det => units[unitKey].children[det].data.detonatorStatus === 1
					);

					blastParticipants.units[unitKey] = [...liveChildren];
					blastParticipants.count++;
				}
			}
		});

		return blastParticipants;
	}

	/**
	 * Sets the state of the Model and Emits the state to be used externally
	 * @param {string} state - eg BLAST_FIRING .
	 * @fires module:lib/models/blastModel.BlastModel#state
	 */
	setState(state) {
		if (
			this.data.state === blastModelStates.BLAST_DATA_COMPLETE ||
			this.data.state === blastModelStates.BLAST_TIMER_COMPLETE ||
			this.data.state === blastModelStates.BLAST_TIMER_COMPLETE_BYPACKET
		)
			return;

		this.event.emit(blastModelEvents.BLASTMODEL_LOG, state);
		this.data.state = state;
	}

	/**
	 * Starts the total timer in a timeout
	 * @param {number} createdAt - when the event started.
	 * @param {number} duration - duration is supplied in the constructor.
	 */
	setTotalTimer(createdAt, duration) {
		return setTimeout(() => {
			this.setState(blastModelStates.BLAST_TIMER_COMPLETE);
			this.closeBlast(createdAt + duration);
		}, duration);
	}

	/**
	 * A number, or a string containing a number.
	 * @typedef {{value: (number|string)}} LogObject
	 * @todo fix this section, it is wrong
	 * @memberof BlastModel#
	 */

	/**
	 * Add Log objects from the Event Service to this blast model
	 * @param {Object} logObj the Log Object Wrapper.
	 * @param {string} logObj.id - id of the obj.
	 * @param {LogObject[]} logObj.value - Array of logs.
	 */
	addLog(logObj) {
		const { createdAt, logType } = logObj;

		if (createdAt > this.expectedComplete) {
			this.setState(blastModelStates.BLAST_TIMER_COMPLETE_BYPACKET);
			this.closeBlast(createdAt);
			return;
		}

		this.data.logs.push(logObj);
		let proceed;

		switch (logType) {
		case eventServiceLogTypes.UNIT_UPDATE:
			proceed = this.handleUnitStateChange(logObj);
			break;
		case eventServiceLogTypes.DET_UPDATE:
			proceed = this.handleDetStateChange(logObj);
			break;
		}

		if (
			proceed &amp;&amp;
			this.watchLists.count === 0 &amp;&amp;
			this.data.state !== blastModelStates.BLAST_DATA_COMPLETE
		) {
			this.setState(blastModelStates.BLAST_DATA_COMPLETE);
			this.closeBlast(createdAt);
		}
	}

	handleUnitStateChange(logObj) {
		const { typeId, events, createdAt } = logObj;
		const logEvents = events[0];

		switch (typeId) {
		case 0:
			if (
				logEvents.hasOwnProperty("diff") &amp;&amp;
					logEvents.diff.hasOwnProperty("fireButton") &amp;&amp;
					logEvents.diff.fireButton === 0
			) {
				this.data.firingComplete = createdAt;
				this.data.firingTime = this.data.firingComplete - this.data.createdAt;
				this.setState(blastModelStates.BLAST_FIRED);
			}
			// TODO need to get event for an DIRARMED TERMINATE
			if (
				logEvents.hasOwnProperty("diff") &amp;&amp;
					logEvents.diff.hasOwnProperty("keySwitchStatus") &amp;&amp;
					logEvents.diff.keySwitchStatus === 0 &amp;&amp;
					this.state === blastModelStates.BLAST_FIRING
			) {
				this.data.firingComplete = createdAt;
				this.data.firingTime = 0;
				this.setState(blastModelStates.BLAST_TERMINATED);
				return false;
			}
			break;
		}

		return true;
	}

	handleDetStateChange(logObj) {
		const { units } = this.watchLists;
		const { serial, events } = logObj;

		if (units.hasOwnProperty(logObj.serial.toString())) {
			const windowIdList = events.map(ev => ev.windowId.toString());

			units[serial] = units[serial].filter(el => {
				return !windowIdList.includes(el);
			});

			if (units[serial].length === 0) {
				delete units[serial];
				this.watchLists.count--;
			}
		}

		return true;
	}

	closeBlast(time) {
		if (this.timer) {
			clearTimeout(this.timer);
			this.timer = null;
		}
		if (!this.firingComplete) this.firingComplete = time;
		this.data.blastClosed = time;
		this.data.blastReturnTime = this.data.blastClosed - this.data.firingComplete;
	}

	setSnapshot(snapshot, position) {
		this.data.snapshots[position] = this.createSnapshot(snapshot).snapShotObj;
	}

	async getBlastReport() {
		return this.data;
	}
}

/**
 * @summary BlastModel State event.
 * @category Services
 * @event state
 * @type {object}
 * @property {string} state - Indicates the state change of the Blast Model.
 * @memberof BlastModel#
 */

module.exports = BlastModel;
</code></pre>
        </article>
    </section>




                </div>
            </div>
        </div>
    </div>

<footer class="footer">
    <div class="content has-text-centered">
        <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Tue Nov 05 2019 12:38:15 GMT+0200 (South Africa Standard Time)</p>
        <p class="sidebar-created-by">
            <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
            <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
        </p>
    </div>
</footer>

<script src="scripts/app.min.js"></script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
