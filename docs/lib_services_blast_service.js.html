

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>JSDoc: lib/services/blast_service.js</title>

    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./build/entry.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Muli:100,400,700|Oswald:300|Inconsolata,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
    <link type="text/css" rel="stylesheet" href="styles/app.min.css">
    <link type="text/css" rel="stylesheet" href="styles/iframe.css">
</head>

<body>
    <div id="stickyNavbarOverlay"></div>
    <div class="top-navbar">
        <div class="container">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                    
                     
                        <h1 class="navbar-item">State Management Server</h1>
                    
                    <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                 
                <div class="navbar-menu">
                    <div class="navbar-end">
                    
                        <div class="navbar-item">
                            <a href="https://github.com/SoftwareBrothers/admin-bro" target="_blank">Github</a>
                        </div>
                    
                        <div class="navbar-item">
                            <a href="https://admin-bro-example-app.herokuapp.com/admin" target="_blank">Example Application</a>
                        </div>
                    
                    </div>
                </div>
                
            </nav>
        </div>
    </div>
    <div class="container">
        <div class="columns">
            <div class="column is-3" id="sidebarNav">
                <div class="sidebar">
                    <nav>
                        <h2><a href="index.html">Home</a></h2><div class="category"><h3>Global</h3><ul><li><a href="global.html#Server">Server</a></li><li><a href="global.html#start">start</a></li></ul></div><div class="category"><h2>Models</h2><h3>Classes</h3><ul><li><a href="BlastModel.html">BlastModel</a></li><li><a href="ControlUnitModel.html">ControlUnitModel</a></li><li><a href="DataModel.html">DataModel</a></li><li><a href="UnitModel.html">UnitModel</a></li></ul></div><div class="category"><h2>Repositories</h2><h3>Classes</h3><ul><li><a href="BlastRepository.html">BlastRepository</a></li></ul></div><div class="category"><h2>Services</h2><h3>Classes</h3><ul><li><a href="BlastService.html">BlastService</a></li><li><a href="DataService.html">DataService</a></li><li><a href="QueueService.html">QueueService</a></li><li><a href="SecurityService.html">SecurityService</a></li><li><a href="SystemService.html">SystemService</a></li><li><a href="uiService.html">uiService</a></li></ul><h3>Events</h3><ul><li><a href="BlastModel.html#event:state">state</a></li><li><a href="DataService.html#event:EDDSIG">EDDSIG</a></li><li><a href="global.html#event:DataService">DataService</a></li></ul></div><div class="category"><h2>System</h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li></ul><h3>Classes</h3><ul><li><a href="module-app-App.html">App</a></li></ul></div><div class="category"><h2>Utilities</h2><h3>Classes</h3><ul><li><a href="DataMapper.html">DataMapper</a></li></ul></div>
                    </nav>
                </div>
            </div>
            <div class="column is-9-desktop">
                <div class="content" id="main-content-wrapper">
                    <header class="page-title">
                        <p>Source</p>
                        <h1>lib/services/blast_service.js</h1>
                    </header>
                    
                    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable no-unused-vars */
const Timer = require("tiny-timer");
const BlastModel = require("../models/blastModel");
const PdfUtil = require("../utils/pdfUtils");
const clone = require("clone");

const { blastModelStates, componentStates } = require("../constants/stateConstants");
const {
	blastModelEvents,
	blastServiceEvents,
	eventServiceEvents
} = require("../constants/eventConstants");

/**
 * @category Services
 * @class BlastService
 * @requires class:BlastModel
 * @requires pdfUtils
 * @property {object} this.currentBlast  The active current Blast
 */
function BlastService() {
	this.currentBlast = null;
	this.eventRefLog = null;
}

/**
 *  &lt;ul>&lt;li>Start the component when Happner starts.&lt;/li>
 * &lt;li> Starts a listener for a BLAST_STARTED event emitted from the dataService&lt;/li>&lt;/ul>&lt;br>
 * @param {$happn} $happn
 * @returns {Promise}
 */
BlastService.prototype.componentStart = function($happn) {
	const { stateService } = $happn.exchange;
	const { name } = $happn;

	return (async () => {
		try {
			stateService.updateState({ service: name, state: componentStates.STARTED });
		} catch (error) {
			stateService.updateState({ service: name, state: componentStates.FAILED, error });
		}
	})();
};

/**
 * @summary Stop the component when Happner stops
 * @param {$happn} $happn
 * @returns {Promise}
 */
BlastService.prototype.componentStop = function($happn) {
	const { stateService } = $happn.exchange;
	const { name } = $happn;

	return (async () => {
		stateService.updateState({ service: name, state: componentStates.STOPPED });
	})();
};

/**
 * @summary Create a new blast
 * @param {$happn} $happn
 * @param {number} createdAt
 * @param {*} snapShot
 * @returns {Promise}
 */
BlastService.prototype.createNewBlast = function($happn, createdAt, snapShot) {
	const { blastService, blastRepository } = $happn.exchange;
	const { env } = $happn.config;
	const { log } = $happn;

	return (async () => {
		try {
			if (this.currentBlast) {
				const msg = "Blast Creation error: Blast in progress - another fire button detected";
				await blastService.logEvent("BLAST_ERROR_LOG", createdAt, msg);
				log.warn(msg);
				return false;
			}

			this.currentBlast = {
				createdAt: createdAt,
				blastEvent: new BlastModel(snapShot, createdAt, env.systemFiringTime, env.systemReportTime)
			};

			const { blastEvent } = this.currentBlast;
			log.info(`Creating new blast - ${blastEvent.data.id} - ${blastEvent.data.createdAt}`);

			await blastRepository.upsertIndex(this.currentBlast);
			await blastRepository.set(this.currentBlast);
			await blastService.subscribeToBlastEvents();

			blastService.startTimer("firing", "BLAST_TIMER", env.systemFiringTime, () => {
				blastService.startTimer("reporting", "REPORT_TIMER", env.systemReportTime);
			});

			await blastService.logEvent(
				"BLAST_STARTED",
				this.currentBlast.blastEvent.data.createdAt,
				null
			);

			return true;
		} catch (err) {
			log.error("Cannot create new Blast Model", err);
		}
	})();
};

/**
 * @summary Subcribe to the blast events
 * @param {$happn} $happn
 * @returns {Promise} void
 */
BlastService.prototype.subscribeToBlastEvents = function($happn) {
	const { blastService } = $happn.exchange;
	const { log, event } = $happn;
	const { blastEvent } = this.currentBlast;

	return (async () => {
		try {
			blastEvent.event.on(blastModelEvents.BLASTMODEL_LOG, async data => {
				const {
					BLAST_TIMER_COMPLETE,
					BLAST_DATA_COMPLETE,
					BLAST_TIMER_COMPLETE_BYPACKET,
					BLAST_TERMINATED
				} = blastModelStates;

				if (
					data === BLAST_TIMER_COMPLETE ||
					data === BLAST_DATA_COMPLETE ||
					data === BLAST_TIMER_COMPLETE_BYPACKET ||
					data === BLAST_TERMINATED
				) {
					await blastService.closeBlast(data);
				}
			});

			event.eventService.on(
				eventServiceEvents.UPDATE_LOG,
				data => {
					if (this.currentBlast) {
						blastService.updateBlast(data);
					}
				},
				(err, evRef) => {
					if (err) throw new Error("Error subscribing to eventService", err);

					this.eventRefLog = evRef;
				}
			);
		} catch (err) {
			log.error(err);
		}
	})();
};

/**
 * @summary Function used to update the blast with any logs
 * @param {$happn} $happn
 * @param {*} logObj
 * @returns {Promise}
 */
BlastService.prototype.updateBlast = function($happn, logObj) {
	const { log } = $happn;
	const { blastRepository } = $happn.exchange;

	return (async () => {
		try {
			this.currentBlast.blastEvent.addLog(logObj);
			//await blastRepository.set(this.currentBlast);
		} catch (err) {
			log.error("Error writing new blast object", err);
		}
	})();
};

/**
 * @summary Close off the Blast - works off this.currentBlast
 * @param {$happn} $happn
 * @returns {Promise}
 */
BlastService.prototype.closeBlast = function($happn, closeProc) {
	const { blastRepository, dataService, blastService } = $happn.exchange;
	const { log, emit } = $happn;

	return (async () => {
		try {
			if (!this.currentBlast) throw new Error("No current blast event to close");
			if (!this.currentBlast.blastEvent) throw new Error("No blast event to close");

			this.currentBlast.blastEvent.event.removeAllListeners(blastModelEvents.BLASTMODEL_LOG);

			log.info(`Closing blast ${this.currentBlast.blastEvent.data.id} with proc(${closeProc})`);

			const snapShot = await dataService.getSnapShot();
			this.currentBlast.blastEvent.setSnapshot(snapShot, "end");

			const cloneBlast = clone(this.currentBlast);
			await blastRepository.set(cloneBlast);
			await blastRepository.upsertIndex(cloneBlast);

			if (this["firing"]) {
				emit("firing", 0);
				this["firing"].stop();
				this["firing"] = null;
			}

			if (this["reporting"]) {
				emit("reporting", 0);
				this["reporting"].stop();
				this["firing"] = null;
			}

			if (this.currentBlast.state === blastModelStates.BLAST_TERMINATED) {
				await blastService.logEvent(
					"BLAST_TERMINATED",
					this.currentBlast.blastEvent.data.blastClosed,
					closeProc
				);
			} else {
				await blastService.logEvent(
					"BLAST_COMPLETED",
					this.currentBlast.blastEvent.data.blastClosed,
					closeProc
				);
			}
			delete this.currentBlast.blastEvent;
			delete this.currentBlast;
		} catch (err) {
			log.error("Error closing Blast Event", err);
		}
	})();
};

/**
 * @summary Sends an event to the event service
 * @param {$happn} $happn
 * @param {string} logType
 * @param {number} createdAt
 * @returns {Promise} void
 */
BlastService.prototype.logEvent = function($happn, logType, createdAt, msg) {
	const { eventService } = $happn.exchange;

	return (async () => {
		await eventService.handleEvent({
			type: blastServiceEvents.BLAST_LOG,
			logType,
			serial: this.currentBlast.blastEvent.data.serial,
			createdAt,
			typeId: 0,
			msg
		});
	})();
};

//#region BLAST REPORT UTILITIES

/**
 * @summary Utility function to remove the Blast ID from
 * the index and the Blast Object in the Blast Repo.
 * @param {$happn} $happn
 * @param {string} id The blast ID to be sent to the PDF utility
 * @returns {promise}
 */
BlastService.prototype.deleteBlast = function($happn, id) {
	const { blastRepository } = $happn.exchange;
	const { log } = $happn;

	return (async () => {
		try {
			log.info("Removing Blast Report", id);
			await blastRepository.delete(id);
			await blastRepository.deleteIndex(id);
			return true;
		} catch (err) {
			log.error("Error deleting blast Report", err);
		}
	})();
};

/**
 * @summary Function to get a Blast JSON Object and send it to the PDF Utility.
 * @param {$happn} $happn
 * @param {string} id The blast ID to be sent to the PDF utility
 * @returns {promise}
 */
BlastService.prototype.pdfBlast = function($happn, id) {
	const { blastRepository } = $happn.exchange;
	const { env } = $happn.config;
	const { log } = $happn;

	return (async () => {
		try {
			const pdfUtils = new PdfUtil();
			const blastReport = await blastRepository.get(id);
			delete blastReport._meta;

			pdfUtils.createContent(blastReport, env.theme);
			let pdfFile = await pdfUtils.createPdf(blastReport);
			return pdfFile;
		} catch (error) {
			log.error("Error creating PDF", error);
		}
	})();
};

BlastService.prototype.startTimer = function($happn, timer, event, duration, callback) {
	const { emit, log } = $happn;

	log.info(`${timer} Started at ${duration}ms`);

	this[timer] = new Timer({ stopwatch: false });

	this[timer].on("tick", ms => emit(event, Math.round(ms / 1000) * 1000));
	this[timer].on("done", () => {
		log.info(`${timer} stopped`);
		emit(event, 0);
		//this[timer].removeAllListeners();
		delete this[timer];
		callback();
	});

	this[timer].start(duration);
};

//#endregion

module.exports = BlastService;
</code></pre>
        </article>
    </section>




                </div>
            </div>
        </div>
    </div>

<footer class="footer">
    <div class="content has-text-centered">
        <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Tue Nov 05 2019 12:53:59 GMT+0200 (South Africa Standard Time)</p>
        <p class="sidebar-created-by">
            <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
            <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
        </p>
    </div>
</footer>

<script src="scripts/app.min.js"></script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
