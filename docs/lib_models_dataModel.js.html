

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      lib/models/dataModel.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      State Server API
    </h3>

    
      <h3>
        Resources
      </h3>
      
        <a href="https://github.com/happner/happner-2">happner-2</a>
      
    

    <h3>Classes</h3><ul><li id="BlastRepository-nav"><a href="BlastRepository.html">BlastRepository</a><ul class='methods'><li data-type="method" id="BlastRepository-set-nav"><a href="BlastRepository.html#set">set</a></li></ul></li><li id="ControlUnitModel-nav"><a href="ControlUnitModel.html">ControlUnitModel</a></li><li id="App-nav"><a href="module-App-App.html">App</a><ul class='methods'><li data-type="method" id="App-componentStart-nav"><a href="module-App-App.html#componentStart">componentStart</a></li><li data-type="method" id="App-componentStop-nav"><a href="module-App-App.html#componentStop">componentStop</a></li><li data-type="method" id="App-startRouter-nav"><a href="module-App-App.html#startRouter">startRouter</a></li></ul></li><li id="DataMapper-nav"><a href="module-lib_mappers_DataMapper-DataMapper.html">DataMapper</a><ul class='methods'><li data-type="method" id="DataMapper-getUpdates-nav"><a href="module-lib_mappers_DataMapper-DataMapper.html#getUpdates">getUpdates</a></li><li data-type="method" id="DataMapper-mapProps-nav"><a href="module-lib_mappers_DataMapper-DataMapper.html#mapProps">mapProps</a></li><li data-type="method" id="DataMapper-mapToUnits-nav"><a href="module-lib_mappers_DataMapper-DataMapper.html#mapToUnits">mapToUnits</a></li></ul></li><li id="BlastService-nav"><a href="module-lib_services_BlastService-BlastService.html">BlastService</a><ul class='methods'><li data-type="method" id="BlastService-closeBlast-nav"><a href="module-lib_services_BlastService-BlastService.html#closeBlast">closeBlast</a></li><li data-type="method" id="BlastService-createNewBlast-nav"><a href="module-lib_services_BlastService-BlastService.html#createNewBlast">createNewBlast</a></li><li data-type="method" id="BlastService-deleteBlast-nav"><a href="module-lib_services_BlastService-BlastService.html#deleteBlast">deleteBlast</a></li><li data-type="method" id="BlastService-logEvent-nav"><a href="module-lib_services_BlastService-BlastService.html#logEvent">logEvent</a></li><li data-type="method" id="BlastService-pdfBlast-nav"><a href="module-lib_services_BlastService-BlastService.html#pdfBlast">pdfBlast</a></li><li data-type="method" id="BlastService-subscribeToBlastEvents-nav"><a href="module-lib_services_BlastService-BlastService.html#subscribeToBlastEvents">subscribeToBlastEvents</a></li><li data-type="method" id="BlastService-updateBlast-nav"><a href="module-lib_services_BlastService-BlastService.html#updateBlast">updateBlast</a></li></ul></li><li id="DataService-nav"><a href="module-lib_services_DataService-DataService.html">DataService</a><ul class='methods'><li data-type="method" id="DataService-clearDataModel-nav"><a href="module-lib_services_DataService-DataService.html#clearDataModel">clearDataModel</a></li><li data-type="method" id="DataService-createDataModel-nav"><a href="module-lib_services_DataService-DataService.html#createDataModel">createDataModel</a></li><li data-type="method" id="DataService-createDataModelListeners-nav"><a href="module-lib_services_DataService-DataService.html#createDataModelListeners">createDataModelListeners</a></li><li data-type="method" id="DataService-getControlUnit-nav"><a href="module-lib_services_DataService-DataService.html#getControlUnit">getControlUnit</a></li><li data-type="method" id="DataService-getUnits-nav"><a href="module-lib_services_DataService-DataService.html#getUnits">getUnits</a></li><li data-type="method" id="DataService-initialise-nav"><a href="module-lib_services_DataService-DataService.html#initialise">initialise</a></li><li data-type="method" id="DataService-persistUnits-nav"><a href="module-lib_services_DataService-DataService.html#persistUnits">persistUnits</a></li><li data-type="method" id="DataService-postProcess-nav"><a href="module-lib_services_DataService-DataService.html#postProcess">postProcess</a></li><li data-type="method" id="DataService-preProcess-nav"><a href="module-lib_services_DataService-DataService.html#preProcess">preProcess</a></li><li data-type="method" id="DataService-unlisten-nav"><a href="module-lib_services_DataService-DataService.html#unlisten">unlisten</a></li><li data-type="method" id="DataService-updateState-nav"><a href="module-lib_services_DataService-DataService.html#updateState">updateState</a></li><li data-type="method" id="DataService-upsertNodeDataArr-nav"><a href="module-lib_services_DataService-DataService.html#upsertNodeDataArr">upsertNodeDataArr</a></li><li data-type="method" id="DataService-validatePersisted-nav"><a href="module-lib_services_DataService-DataService.html#validatePersisted">validatePersisted</a></li></ul></li><li id="EndpointService-nav"><a href="module-lib_services_EndpointService-EndpointService.html">EndpointService</a><ul class='methods'><li data-type="method" id="EndpointService-checkForEndpoint-nav"><a href="module-lib_services_EndpointService-EndpointService.html#checkForEndpoint">checkForEndpoint</a></li><li data-type="method" id="EndpointService-componentStop-nav"><a href="module-lib_services_EndpointService-EndpointService.html#componentStop">componentStop</a></li><li data-type="method" id="EndpointService-start-nav"><a href="module-lib_services_EndpointService-EndpointService.html#start">start</a></li></ul></li><li id="EventService-nav"><a href="module-lib_services_PacketService-EventService.html">EventService</a><ul class='methods'><li data-type="method" id="EventService-handleEvent-nav"><a href="module-lib_services_PacketService-EventService.html#handleEvent">handleEvent</a></li></ul></li><li id="PacketService-nav"><a href="module-lib_services_PacketService-PacketService.html">PacketService</a></li><li id="QueueService-nav"><a href="module-lib_services_QueueService-QueueService.html">QueueService</a><ul class='methods'><li data-type="method" id="QueueService-addToQueue-nav"><a href="module-lib_services_QueueService-QueueService.html#addToQueue">addToQueue</a></li><li data-type="method" id="QueueService-processIncoming-nav"><a href="module-lib_services_QueueService-QueueService.html#processIncoming">processIncoming</a></li><li data-type="method" id="QueueService-validatePacket-nav"><a href="module-lib_services_QueueService-QueueService.html#validatePacket">validatePacket</a></li></ul></li><li id="SecurityService-nav"><a href="module-lib_services_SecurityService-SecurityService.html">SecurityService</a><ul class='methods'><li data-type="method" id="SecurityService-checkStartUpUsers-nav"><a href="module-lib_services_SecurityService-SecurityService.html#checkStartUpUsers">checkStartUpUsers</a></li><li data-type="method" id="SecurityService-listUsers-nav"><a href="module-lib_services_SecurityService-SecurityService.html#listUsers">listUsers</a></li><li data-type="method" id="SecurityService-setStartupUsers-nav"><a href="module-lib_services_SecurityService-SecurityService.html#setStartupUsers">setStartupUsers</a></li><li data-type="method" id="SecurityService-start-nav"><a href="module-lib_services_SecurityService-SecurityService.html#start">start</a></li><li data-type="method" id="SecurityService-upsertUiUser-nav"><a href="module-lib_services_SecurityService-SecurityService.html#upsertUiUser">upsertUiUser</a></li></ul></li><li id="SystemService-nav"><a href="module-lib_services_SystemServices-SystemService.html">SystemService</a><ul class='methods'><li data-type="method" id="SystemService-checkConfiguration-nav"><a href="module-lib_services_SystemServices-SystemService.html#checkConfiguration">checkConfiguration</a></li><li data-type="method" id="SystemService-deleteConfig-nav"><a href="module-lib_services_SystemServices-SystemService.html#deleteConfig">deleteConfig</a></li><li data-type="method" id="SystemService-getConfigData-nav"><a href="module-lib_services_SystemServices-SystemService.html#getConfigData">getConfigData</a></li><li data-type="method" id="SystemService-resetRouterData-nav"><a href="module-lib_services_SystemServices-SystemService.html#resetRouterData">resetRouterData</a></li><li data-type="method" id="SystemService-resetUsers-nav"><a href="module-lib_services_SystemServices-SystemService.html#resetUsers">resetUsers</a></li><li data-type="method" id="SystemService-setConfigData-nav"><a href="module-lib_services_SystemServices-SystemService.html#setConfigData">setConfigData</a></li><li data-type="method" id="SystemService-upsertHistory-nav"><a href="module-lib_services_SystemServices-SystemService.html#upsertHistory">upsertHistory</a></li></ul></li><li id="BlastModel-nav"><a href="module-models_BlastModel-BlastModel.html">BlastModel</a><ul class='methods'><li data-type="method" id="BlastModel-addLog-nav"><a href="module-models_BlastModel-BlastModel.html#addLog">addLog</a></li><li data-type="method" id="BlastModel-aggregateUnits-nav"><a href="module-models_BlastModel-BlastModel.html#aggregateUnits">aggregateUnits</a></li><li data-type="method" id="BlastModel-createSnapshot-nav"><a href="module-models_BlastModel-BlastModel.html#createSnapshot">createSnapshot</a></li><li data-type="method" id="BlastModel-extractWatchLists-nav"><a href="module-models_BlastModel-BlastModel.html#extractWatchLists">extractWatchLists</a></li><li data-type="method" id="BlastModel-setState-nav"><a href="module-models_BlastModel-BlastModel.html#setState">setState</a></li><li data-type="method" id="BlastModel-setTotalTimer-nav"><a href="module-models_BlastModel-BlastModel.html#setTotalTimer">setTotalTimer</a></li><li data-type="method" id="BlastModel-validate-nav"><a href="module-models_BlastModel-BlastModel.html#validate">validate</a></li></ul></li><li id="DataModel-nav"><a href="module-models_DataModel-DataModel.html">DataModel</a><ul class='methods'><li data-type="method" id="DataModel-applyUpdate-nav"><a href="module-models_DataModel-DataModel.html#applyUpdate">applyUpdate</a></li><li data-type="method" id="DataModel-getUnit-nav"><a href="module-models_DataModel-DataModel.html#getUnit">getUnit</a></li><li data-type="method" id="DataModel-insertUnit-nav"><a href="module-models_DataModel-DataModel.html#insertUnit">insertUnit</a></li><li data-type="method" id="DataModel-resetChildCount-nav"><a href="module-models_DataModel-DataModel.html#resetChildCount">resetChildCount</a></li><li data-type="method" id="DataModel-snapShot-nav"><a href="module-models_DataModel-DataModel.html#snapShot">snapShot</a></li><li data-type="method" id="DataModel-updateBoosterConnections-nav"><a href="module-models_DataModel-DataModel.html#updateBoosterConnections">updateBoosterConnections</a></li><li data-type="method" id="DataModel-updateBoosterCounts-nav"><a href="module-models_DataModel-DataModel.html#updateBoosterCounts">updateBoosterCounts</a></li><li data-type="method" id="DataModel-updateEddCounts-nav"><a href="module-models_DataModel-DataModel.html#updateEddCounts">updateEddCounts</a></li><li data-type="method" id="DataModel-updateUnit-nav"><a href="module-models_DataModel-DataModel.html#updateUnit">updateUnit</a></li><li data-type="method" id="DataModel-updateUnitState-nav"><a href="module-models_DataModel-DataModel.html#updateUnitState">updateUnitState</a></li><li data-type="method" id="DataModel-upsertUnit-nav"><a href="module-models_DataModel-DataModel.html#upsertUnit">upsertUnit</a></li></ul></li><li id="Extractors-nav"><a href="module-models_Extractors-Extractors.html">Extractors</a><ul class='methods'><li data-type="method" id="Extractors-convertRaw-nav"><a href="module-models_Extractors-Extractors.html#convertRaw">convertRaw</a></li><li data-type="method" id="Extractors-extractCbbRawData-nav"><a href="module-models_Extractors-Extractors.html#extractCbbRawData">extractCbbRawData</a></li><li data-type="method" id="Extractors-extractCFC-nav"><a href="module-models_Extractors-Extractors.html#extractCFC">extractCFC</a></li><li data-type="method" id="Extractors-extractControlUnit-nav"><a href="module-models_Extractors-Extractors.html#extractControlUnit">extractControlUnit</a></li><li data-type="method" id="Extractors-extractEDDListData-nav"><a href="module-models_Extractors-Extractors.html#extractEDDListData">extractEDDListData</a></li><li data-type="method" id="Extractors-extractEddRawData-nav"><a href="module-models_Extractors-Extractors.html#extractEddRawData">extractEddRawData</a></li><li data-type="method" id="Extractors-extractIBS-nav"><a href="module-models_Extractors-Extractors.html#extractIBS">extractIBS</a></li><li data-type="method" id="Extractors-extractWifi-nav"><a href="module-models_Extractors-Extractors.html#extractWifi">extractWifi</a></li><li data-type="method" id="Extractors-reverseSerialBytes-nav"><a href="module-models_Extractors-Extractors.html#reverseSerialBytes">reverseSerialBytes</a></li></ul></li><li id="uiService-nav"><a href="uiService.html">uiService</a><ul class='methods'><li data-type="method" id="uiService-delete-nav"><a href="uiService.html#delete">delete</a></li><li data-type="method" id="uiService-get-nav"><a href="uiService.html#get">get</a></li><li data-type="method" id="uiService-getAxxisDash-nav"><a href="uiService.html#getAxxisDash">getAxxisDash</a></li><li data-type="method" id="uiService-set-nav"><a href="uiService.html#set">set</a></li><li data-type="method" id="uiService-setAxxisDash-nav"><a href="uiService.html#setAxxisDash">setAxxisDash</a></li></ul></li><li id="UnitModel-nav"><a href="UnitModel.html">UnitModel</a></li></ul><h3>Modules</h3><ul><li id="App-nav"><a href="module-App.html">App</a></li><li id="lib_mappers/DataMapper-nav"><a href="module-lib_mappers_DataMapper.html">lib/mappers/DataMapper</a></li><li id="lib_services/BlastService-nav"><a href="module-lib_services_BlastService.html">lib/services/BlastService</a></li><li id="lib_services/DataService-nav"><a href="module-lib_services_DataService.html">lib/services/DataService</a></li><li id="lib_services/EndpointService-nav"><a href="module-lib_services_EndpointService.html">lib/services/EndpointService</a></li><li id="lib_services/PacketService-nav"><a href="module-lib_services_PacketService.html">lib/services/PacketService</a></li><li id="lib_services/QueueService-nav"><a href="module-lib_services_QueueService.html">lib/services/QueueService</a></li><li id="lib_services/SecurityService-nav"><a href="module-lib_services_SecurityService.html">lib/services/SecurityService</a></li><li id="lib_services/SystemServices-nav"><a href="module-lib_services_SystemServices.html">lib/services/SystemServices</a></li><li id="models_BlastModel-nav"><a href="module-models_BlastModel.html">models/BlastModel</a></li><li id="models_DataModel-nav"><a href="module-models_DataModel.html">models/DataModel</a></li><li id="models_Extractors-nav"><a href="module-models_Extractors.html">models/Extractors</a></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#Server">Server</a></li><li><a href="global.html#start">start</a></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        lib/models/dataModel.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>/* eslint-disable max-len */
/* eslint-disable no-unused-vars */

const DataMapper = require("../mappers/data_mapper");
const { ControlUnitModel } = require("../models/unitModels");
const EventEmitter = require("events").EventEmitter;
const clone = require("clone");

const { dataModelEvents, unitModelEvents } = require("../constants/eventConstants");
const { unitTypes, systemModeTypes } = require("../constants/typeConstants");

/**
 * @category Models
 * @module models/DataModel
 */

/**
 * @class
 * @summary The DataModel which represents the state of the Data.
 * @extends EventEmitter
 */
class DataModel extends EventEmitter {
	constructor() {
		super();
		this.controlUnit = null;
		this.units = {};
		this.auxUnits = {};

		this.mapper = new DataMapper();
		this.mode = null;
		this.pseudoTime = null;
	}

	setMode(mode) {
		if (!mode) throw new Error("Mode cannot be empty - check ENV");
		this.mode = mode;
	}

	setPseudoTime(time) {
		this.pseudoTime = time;
		const allUnits = Object.keys(this.units);
		allUnits.forEach(unit => this.units[unit].updatePseudoTime(time));
	}

	/**
	 * @summary Upsert unit data
	 * @param {unitObj} nextState
	 * @param {boolean} forceFlag force an update even if there are no diffs
	 * @returns {Promise} void
	 * @todo Check that this is functioning correctly
	 * @mermaid graph LR
	 * 				subgraph incoming
						A[dataService]
					end
					subgraph upsertUnit
					A[dataService] -.->|nextState|getUnit
						getUnit -->|true|diff{diff}
					end
					subgraph external
						diff -->|false|insertUnit
						diff -->|true|updateUnit
					end

	 */
	async upsertUnit(nextState, forceFlag) {
		try {
			const { serial, typeId, createdAt } = nextState.data;

			this.setPseudoTime(createdAt);
			let prevState = this.getUnit(nextState);

			if (!prevState &amp;&amp; !serial &amp;&amp; typeId === 4) {
				throw new Error("cannot add this detonator as it does not exist in the model");
			}

			if (!prevState) {
				let inserted = await this.insertUnit(nextState);
				if (!inserted) throw new Error(inserted);
				return { action: "INSERT", value: { ...nextState } };
			}

			//check if the Control Unit matches.
			//TODO need to work out solution for no control unit when ccb is there
			if (
				typeId === unitTypes.CONTROL_UNIT &amp;&amp;
				serial !== prevState.data.serial &amp;&amp;
				prevState.data.serial !== null
			) {
				throw new Error(
					`Control Unit ${serial} does not match current serial ${prevState.data.serial}. Please re-initialise the system`
				);
			}

			if (typeId === unitTypes.BOOSTER_T2) {
				prevState.setLastCommunication();
			}

			let diffs = null;
			diffs = await this.mapper.getUpdates(nextState, prevState);

			if (!diffs &amp;&amp; forceFlag !== true) {
				return { action: "NONE", value: { ...nextState } };
			}

			await this.updateUnit(prevState, nextState, diffs, forceFlag);

			return { action: "UPDATE", value: { ...nextState, diff: diffs } };
		} catch (error) {
			console.log(error);
			return { action: "ERROR", error };
		}
	}

	/**
	 * @summary Insert a unit into the model if it is not found
	 * @param {unitObj} unit
	 * @returns {Promise}
	 * @todo Need to work out solution for the main comms issue with the cbb with timeout.
	 */
	async insertUnit(unit) {
		const { typeId, serial, createdAt } = unit.data;

		switch (typeId) {
		case unitTypes.CONTROL_UNIT:
			this.controlUnit = unit;
			break;

		case unitTypes.BOOSTER_T2:
			{
				const { keySwitchStatus, communicationStatus } = unit.data;
				this.units[serial] = unit;

				// set up event to send lost comms to dataservice
				this.units[serial].event.on(unitModelEvents.UNIT_COMM_LOST, (boosterUnit, createdAt) => {
					const { serial, typeId } = boosterUnit.data;
					this.emit(dataModelEvents.UNIT_COMMS_LOST, { serial, typeId, createdAt });
				});

				if (!this.controlUnit) {
					this.controlUnit = new ControlUnitModel(null, null);
					this.controlUnit.data.createdAt = createdAt;
				}

				this.controlUnit.units.unitsCount++;
				await this.updateBoosterCounts({
					keySwitchStatus,
					communicationStatus
				});

				unit.setLastCommunication(unit.data.createdAt);

				this.emitUnitCountUpdate({
					serial: unit.data.parentSerial,
					typeId: unitTypes.CONTROL_UNIT,
					createdAt,
					counts: this.controlUnit.units
				});
			}
			break;

		case unitTypes.EDD:
			{
				const { tagged, logged, detonatorStatus } = unit.data;
				const { program, parentSerial } = unit.data;

				const { windowId } = unit.data;
				if (windowId === null) throw new Error("Window ID cannot be null");

				switch (this.mode) {
				case systemModeTypes.AXXIS100 || systemModeTypes.AXXIS100_CFC:
					if (windowId > 101) throw new Error("Window ID cannot be higher that 101");
					break;

				case systemModeTypes.AXXIS500 ||
							systemModeTypes.AXXIS500_CFC ||
							systemModeTypes.AXXIS500_WIFI:
					if (windowId > 501) throw new Error("Window ID cannot be higher that 101");
					break;

				case systemModeTypes.HYDRA:
					if (windowId > 501) throw new Error("Window ID cannot be higher that 101");
					break;
				}

				this.units[parentSerial].children[windowId] = unit;
				this.units[parentSerial].units.unitsCount++;

				await this.updateEddCounts(null, unit, {
					tagged,
					logged,
					detonatorStatus,
					program
				});

				this.emitUnitCountUpdate({
					serial: parentSerial,
					typeId: unitTypes.BOOSTER_T2,
					createdAt,
					counts: this.units[parentSerial].units
				});
			}
			break;
		case unitTypes.CFC:
			{
				this.auxUnits[serial] = unit;
			}
			break;

		default:
			return false;
		}

		await unit.setPath();
		return true;
	}

	/**
	 * @summary Update a unit that is found
	 * @param {unitObj} prevState state found in the model
	 * @param {unitObj} nextState incoming state
	 * @param {diffObj} diffs found diffs
	 * @returns {Promise}
	 */
	async updateUnit(prevState, nextState, diffs, forceFlag) {
		const { typeId, serial, createdAt } = nextState.data;

		this.updateUnitState(nextState);

		switch (typeId) {
		case unitTypes.CONTROL_UNIT:
			nextState.data = await this.applyUpdate(prevState.data, diffs, createdAt, forceFlag);
			this.controlUnit.data = nextState.data;
			break;

		case unitTypes.BOOSTER_T2:
			{
				let countUpdate = await this.updateBoosterCounts(diffs);
				nextState.data = await this.applyUpdate(prevState.data, diffs, createdAt, forceFlag);

				this.units[serial].data = nextState.data;

				if (countUpdate) {
					this.emitUnitCountUpdate({
						serial: this.controlUnit.data.serial,
						createdAt,
						typeId: unitTypes.CONTROL_UNIT,
						counts: this.controlUnit.units
					});
				}
			}
			break;

		case unitTypes.EDD:
			{
				const { windowId, parentSerial, delay } = nextState.data;

				if (windowId === null) throw new Error("Window ID cannot be null");

				switch (this.mode) {
				case systemModeTypes.AXXIS100 || systemModeTypes.AXXIS100_CFC:
					if (windowId > 101) throw new Error("Window ID cannot be higher that 101");
					if (delay > 15000) throw new Error("Invalid Delay Packet discarded");
					break;

				case systemModeTypes.AXXIS500 ||
							systemModeTypes.AXXIS500_CFC ||
							systemModeTypes.AXXIS500_WIFI:
					if (windowId > 600) throw new Error("Window ID cannot be higher that 101");
					if (delay > 15000) throw new Error("Invalid Delay Packet discarded");
					break;

				case systemModeTypes.HYDRA:
					if (windowId > 600) throw new Error("Window ID cannot be higher that 101");
					if (delay > 40000) throw new Error(`Invalid Delay Packet discarded - ${delay}`);
					break;
				}

				let countUpdate = await this.updateEddCounts(prevState, nextState, diffs);

				nextState.data = await this.applyUpdate(prevState.data, diffs, createdAt, forceFlag);
				this.units[parentSerial].children[windowId].data = nextState.data;

				if (countUpdate) {
					this.emitUnitCountUpdate({
						serial: parentSerial,
						typeId: unitTypes.BOOSTER_T2,
						createdAt,
						counts: this.units[parentSerial].units
					});
				}
			}
			break;

		case unitTypes.CFC:
			nextState.data = await this.applyUpdate(prevState.data, diffs, createdAt, forceFlag);
			this.auxUnits[serial].data = nextState.data;
			break;

		default:
			return;
		}

		if (!nextState.data.path || nextState.data.path === "") {
			await nextState.setPath();
		}
		return true;
	}

	/**
	 * @summary getUnit using its state
	 * @param {unitObj} nextState
	 * @returns {Promise&lt;unitObj>} return found unit or null
	 */
	getUnit(nextState) {
		const { typeId, serial } = nextState.data;

		switch (typeId) {
		case unitTypes.CONTROL_UNIT: {
			return this.controlUnit;
		}

		case unitTypes.BOOSTER_T2: {
			return this.units[serial];
		}

		case unitTypes.EDD: {
			const { parentSerial, windowId } = nextState.data;

			if (!this.units[parentSerial])
				throw new Error(`Unit ${parentSerial} does not exist. Cannot get information.`);

			return this.units[parentSerial].children[windowId];
		}

		case unitTypes.CFC: {
			return this.auxUnits[serial];
		}

		default:
			return null;
		}
	}

	/**
	 * @summary Applies the diffs to the State
	 * @param {unitObj} state
	 * @param {diffObj} diffs the diffs between the current state and previous state
	 * @param {number} modifiedAt timestamp on modifiedAt
	 * @returns {Promise&lt;unitObj>} return found unit or null
	 */
	async applyUpdate(state, diff, modifiedAt, forceFlag) {
		if (diff) {
			for (const key in diff) {
				if (state.hasOwnProperty(key)) {
					if (diff[key] !== null) {
						state[key] = diff[key];
					}
				}
			}
			state.modifiedAt = modifiedAt;
		}

		if (forceFlag === true) state.modifiedAt = modifiedAt;

		return state;
	}

	/**
	 * @summary Applies the diffs to the State
	 * @param {unitObj} state
	 * @param {diffObj} diffs the diffs between the current state and previous state
	 * @param {number} modifiedAt timestamp on modifiedAt
	 * @returns {Promise&lt;unitObj>} return found unit or null
	 */
	updateUnitState(unit) {
		const { typeId } = unit.data;
		try {
			switch (typeId) {
			case unitTypes.CONTROL_UNIT:
				{
					const { keySwitchStatus, fireButton } = unit.data;
					if (keySwitchStatus === 1 &amp;&amp; fireButton === 1) {
						unit.state = "FIRING";
					}
					if (fireButton === 0 &amp;&amp; keySwitchStatus === 1) {
						unit.state = "ARMED";
					} else {
						unit.state = "DISARMED";
					}
				}
				break;

			default:
				return unit;
			}
			return unit;
		} catch (err) {
			console.log(err);
		}
	}

	/**
	 * @summary Uppdate the booster counts on the control unit
	 * @param {diffObj} diffs the diffs between the current state and previous state
	 * @returns {Promise&lt;unitObj>} return found unit or null
	 */
	async updateBoosterCounts(diffs) {
		try {
			if (!diffs) return false;
			//take the incoming state and check is you need to add or remove item in the count on the control unit
			const items = ["keySwitchStatus", "communicationStatus"];

			for (const item of items) {
				if (diffs.hasOwnProperty(item)) {
					let objKey = this.controlUnit.units[`${item}Count`];

					if (diffs[item] === 1) {
						objKey++;
					} else {
						if (objKey > 0) {
							if (diffs[item] == 0) {
								objKey--;
							}
						}
					}
					this.controlUnit.units[`${item}Count`] = objKey;
				}
			}
			return true;
		} catch (err) {
			console.log(err);
		}
	}

	/**
	 * @summary Update the booster connections
	 * @param {number} modifiedAt
	 * @returns {Promise&lt;units>} return array of boosters
	 * @todo Check if this should be moved out of the model and into a service
	 */
	async updateBoosterConnections(modifiedAt) {
		try {
			let resultArr = [];

			const boosterKey = Object.keys(this.units);

			for (const unit of boosterKey) {
				const booster = clone(this.units[unit]);
				booster.data.communicationStatus = 0;
				booster.data.modifiedAt = modifiedAt;

				resultArr.push(booster);
			}

			return resultArr;
		} catch (err) {
			console.error(err);
		}
	}

	/**
	 * @summary Update the EDD counts
	 * @param {nextState} nextState object
	 * @param {diffObj} diffs
	 * @returns {Promise&lt;units>} return array of boosters
	 * @todo Check if this should be moved out of the model and into a service
	 */
	async updateEddCounts(prevState, nextState, diffs) {
		try {
			if (!diffs) return false;

			//take the incoming state and check is you need to add or remove item in the count on the control unit
			const { parentSerial } = nextState.data;
			const parent = this.units[parentSerial];

			const items = ["detonatorStatus", "logged", "tagged", "program"];

			for (const item of items) {
				if (diffs.hasOwnProperty(item)) {
					let objKey = parent.units[`${item}Count`];

					if (diffs[item] === 1) {
						objKey++;
					} else if (diffs[item] === 0) {
						if (objKey > 0) {
							if (diffs[item] === 0 &amp;&amp; prevState &amp;&amp; prevState.data[item] !== null) {
								objKey--;
							}
						}
					}
					this.units[parentSerial].units[`${item}Count`] = objKey;
				}
			}
			return true;
		} catch (err) {
			console.error(err);
		}
	}

	/**
	 * @summary Reset the child counts to 0
	 * @param {object} nextState object
	 * @returns {Promise&lt;units>} return array of boosters
	 * @todo Check if this should be moved out of the model and into a service
	 */
	async resetChildCount(nextState) {
		try {
			const { serial, createdAt } = nextState.data;
			if (this.units[serial]) {
				this.units[serial].children = {};
				this.units[serial].units = {
					unitsCount: 0,
					taggedCount: 0,
					loggedCount: 0,
					programCount: 0,
					detectedCount: 0,
					detonatorStatusCount: 0
				};

				this.emitUnitCountUpdate({
					serial,
					typeId: unitTypes.BOOSTER_T2,
					createdAt,
					counts: this.units[serial].units
				});
			}
		} catch (err) {
			console.log(err);
		}
	}

	emitUnitCountUpdate(obj) {
		this.emit(dataModelEvents.UNIT_COUNT_UPDATED, obj);
	}

	/**
	 * @summary Take a snapshot of the state
	 * @returns {Promise&lt;object>} return array of boosters
	 * @todo Check if this should be moved out of the model and into a service
	 */
	async snapShot() {
		try {
			let controlUnit = clone(this.controlUnit);
			let units = clone(this.units);
			let auxUnits = clone(this.auxUnits);

			const unitsKeys = Object.keys(units);
			unitsKeys.forEach(u => {
				delete units[u].event;
				delete units[u].meta;
			});

			const auxUnitsKeys = Object.keys(auxUnits);
			auxUnitsKeys.forEach(u => {
				delete auxUnits[u].event;
				delete auxUnits[u].meta;
			});
			//console.log(JSON.stringify({ controlUnit, units, auxUnits }));

			return { controlUnit, units, auxUnits };
		} catch (err) {
			console.log(err);
		}
	}
}

module.exports = DataModel;
</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
